stages:
  - test
  - deploy

variables:
  NVM_VERSION: 0.39.1
  NODE_VERSION: 10.19.0

test:
  stage: test
  image: ubuntu:20.04
  before_script:
    - apt-get update
    - apt-get upgrade -y
    - apt-get install -y tzdata
    - apt-get install -y wget
    - apt-get install -y git
    - git submodule update --init
    - wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v$NVM_VERSION/install.sh | bash
    - export NVM_DIR="$([ -z "${XDG_CONFIG_HOME-}" ] && printf %s "${HOME}/.nvm" || printf %s "${XDG_CONFIG_HOME}/nvm")" && [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    - source ~/.bashrc
    - nvm install $NODE_VERSION
    - wget -O /tmp/chrome.deb https://dl.google.com/linux/chrome/deb/pool/main/g/google-chrome-stable/google-chrome-stable_99.0.4844.82-1_amd64.deb
    - apt install -y /tmp/chrome.deb
    - cd lib/jsorolla && npm install && cd ../.. && npm install
  script:
    - npm install -g grunt-cli
    - apt-get install xvfb && Xvfb :99 & export DISPLAY=:99
    - grunt --env=staging
  environment:
    name: test-env
  only:
    - external_pull_requests
    - tags
    - master
    - test_deployment