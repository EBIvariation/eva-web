
<template>
    <div class="row">
        <div id="dgva-study-browser" class="col-md-12">

        </div>
    </div>
</template>

<script>
    // This document reference
    var dgvastudyBrowserDoc = document._currentScript.ownerDocument;

    var dgvastudyBrowser = document.registerElement('dgva-study-browser', {
        prototype: Object.create(HTMLElement.prototype, {
            /*
             * Lifecycle callback methods
             */
            createdCallback: {
                value: function () {
                    var _this = this;
                    //Create a copy of the template node.
                    var template = document.importNode(dgvastudyBrowserDoc.querySelector('template').content, true);
                    _this.appendChild(template);

                }
            },
            attributeChangedCallback:{
                value: function (attrName, oldValue, newValue) {
                    var _this = this;
//                   if(attrName == 'display' &&  newValue == 'true'){
//                       $("#dgva-study-browser").attr('style', 'display: inline');
//                       $("#eva-study-browser").attr('style', 'display: none');
//                   }else{
//                       $("#eva-study-browser").attr('style', 'display: inline');
//                       $("#dgva-study-browser").attr('style', 'display: none');
//                   }
                }
            },
            attachedCallback: {
                value: function () {
                    var _this = this;
                    _this.dgvaStudyBrowserDiv = document.querySelector('dgva-study-browser');
                    _this.dgvaStudyBrowserDiv.innerHTML= '';
//                    _this.dgvaStudyBrowserDiv.setAttribute('class', 'eva-study-browser-div');
//                    _this.dgvaStudyBrowserDiv.setAttribute('id', 'dgva-study-browser');
//                    _this.dgvaStudyBrowser= _this.querySelector("#dgva-study-browser");
//                   if(_this.dgvaStudyBrowser == null ){
//                       _this.appendChild(_this.dgvaStudyBrowserDiv);
                       this.studyBrowserDgva = _this._createStudyBrowser(_this.dgvaStudyBrowserDiv);
                       this.studyBrowserDgva.draw();
//                       this.studyBrowser.update();
//                   }
//                    var display = this.getAttribute('display');
//                    this.display = display;
//                    var t = setTimeout(_this._toggleDisplay, 300);
//
//                    function function2(){
//                        if(display == 'true'){
//                            $("#dgva-study-browser").attr('style', 'display: inline');
//                            $("#eva-study-browser").attr('style', 'display: none');
//                        }else{
//                            $("#eva-study-browser").attr('style', 'display: inline');
//                            $("#dgva-study-browser").attr('style', 'display: none');
//                        }
//                    }





                }
            },
            _createStudyBrowser:{
                value:function(target){
                    var _this = this;
                    var variantStudyBrowser = new DgvaStudyBrowserPanel({
                        target: target,
                        title: 'Structural Variation Study Browser',
                        headerConfig: {
                            baseCls: 'eva-header-1'
                        },
                        width: 1300,
                        height: 420,
                        autoRender: false,
                        pageSize:10
                    });

                    return variantStudyBrowser;
                }
            },
            _toggleDisplay:{
                value:function(){
                    if(this.display == 'true'){
                        $("#dgva-study-browser").attr('style', 'display: inline');
                        $("#eva-study-browser").attr('style', 'display: none');
                    }else{
                        $("#eva-study-browser").attr('style', 'display: inline');
                        $("#dgva-study-browser").attr('style', 'display: none');
                    }
                }
            },




        })
    });



    function DgvaStudyBrowserPanel(args) {
        _.extend(this, Backbone.Events);
        this.id = Utils.genId("DgvaStudyBrowserPanel");

        this.target;
        this.title = "Study Browser";
        this.height = 800;
        this.autoRender = true;
        this.pageSize = 20;
//    this.studies = [];
//    this.studiesStore;
        this.border = false;
        this.speciesList = [
            {
                assembly: "GRCh37.p7",
                common: "human",
                id: "extModel256-1",
                sciAsembly: "Homo sapiens (GRCh37.p7)",
                scientific: "Homo sapiens",
                species: "hsa"
            }
        ];

        this.studiesStore = Ext.create('Ext.data.Store', {
            pageSize: 20,
            proxy: {
                type: 'memory'
            },
            fields: [
                {name: 'id', type: 'string'},
                {name: 'name', type: 'string'}
            ],
            autoLoad: false
        });

        _.extend(this, args);

        this.on(this.handlers);

        this.rendered = false;

        if (this.autoRender) {
            this.render();
        }

        this.load();
    }

    DgvaStudyBrowserPanel.prototype = {
        render: function () {

            if(!this.rendered) {
                this.div = document.createElement('div');
                this.div.setAttribute('id', this.id);
                this.panel = this._createPanel();
                this.rendered = true;
            }
        },

        draw: function () {
            if(!this.rendered) {
                this.render();
            }
            // Checking whether 'this.target' is a HTMLElement or a string.
            // A DIV Element is needed to append others HTML Elements
            this.targetDiv = (this.target instanceof HTMLElement) ? this.target : document.querySelector('#' + this.target);
            if (!this.targetDiv) {
                console.log('DGVAStudyBrowserPanel: target ' + this.target + ' not found');
                return;
            }
            this.targetDiv.appendChild(this.div);

            this.panel.render(this.div);
        },

        load: function (values) {
            var _this = this;
            if(!values){
                if(_this.formPanel){
                    values = _this.formPanel.getValues();
                    values['structural']= true;
                }else{
                    values = {structural:true};
                }
            }

            for (key in values) {
                if (values[key] == '') {
                    delete values[key]
                }else{
                    // TO Be Removed
                    if(key === 'species'){
                        var tempArray = [];
                        // changing values to lower case
                        for (var i = 0; i < values[key].length; i++) {
                            tempArray.push( values[key][i].toLowerCase());
                        }
                        values[key] = tempArray;
                    }

                }
            }

//        this.studiesStore.clearFilter();

//            EvaManager.get({
//                host: 'http://wwwdev.ebi.ac.uk/eva/webservices/rest',
//                category: 'meta/studies',
//                resource: 'all',
//                params: values,
//                success: function (response) {
//                    var studies = [];
//                    try {
//                        studies = response.response[0].result;
//                    } catch (e) {
//                        console.log(e);
//                    }
//                   _this.studiesStore.loadRawData(studies);
//                }
//            });

           if(_this.grid){
               var studies = [];
               EvaManager.get({
                   host: 'http://wwwdev.ebi.ac.uk/eva/webservices/rest',
                   category: 'meta/studies',
                   resource: 'all',
                   params: values,
                   success: function (response) {
                       var studies = [];
                       try {
                           studies = response.response[0].result;
                           this.studiesStore = Ext.create('Ext.data.Store', {
                               fields: [
                                   {name: 'id', type: 'string'},
                                   {name: 'name', type: 'string'}
                               ],
                               remoteSort: true,
                               pageSize:_this.pageSize,
                               proxy: {
                                   type: 'memory',
                                   data: studies,
                                   reader: {
                                       type: 'json'
                                   },
                                   enablePaging: true
                               }
                           });

                           var searchValue = values.search;
                           if (searchValue == "") {
                               this.studiesStore.clearFilter();
                           } else {
                               var regex = new RegExp(searchValue, "i");
                               this.studiesStore.filterBy(function (e) {//
                                   return regex.test(e.get('name')) || regex.test(e.get('description'));
                               });
                           }
                           _this.grid.reconfigure(this.studiesStore);
                           _this.paging.bindStore(this.studiesStore);
                           _this.paging.doRefresh();
                       } catch (e) {
                           console.log(e);
                       }
                   }
               });
           }


        },
        _createPanel: function () {
            var _this = this;
            var stores = {
                species: Ext.create('Ext.data.Store', {
                    autoLoad: true,
                    fields: ['display', 'count'],
                    data: []
                }),
                type: Ext.create('Ext.data.Store', {
                    autoLoad: true,
                    fields: ['display', 'count'],
                    data: []
                }),
                scope: Ext.create('Ext.data.Store', {
                    autoLoad: true,
                    fields: ['display', 'count'],
                    data: []
                }),
                material: Ext.create('Ext.data.Store', {
                    autoLoad: true,
                    fields: ['display', 'count'],
                    data: []
                })
            };

            var assemblyStore = Ext.create('Ext.data.Store', {
                autoLoad: true,
                fields: ['text', 'value'],
                data: [
                    {display: '37', value: '37'}
                ]
            });

            var platformStore = Ext.create('Ext.data.Store', {
                autoLoad: true,
                fields: ['text', 'value'],
                data: [
                    {display: 'Illumina', value: 'ngs'},
                    {display: 'Roche', value: 'array'},
                    {display: 'ABI', value: 'array'}
                ]
            });



            var speciesFieldTag = Ext.create('Ext.form.field.Tag', {
                fieldLabel: 'Organisms',
//            labelWidth: this.labelWidth,
                labelAlign: 'top',
                store: stores.species,
                queryMode: 'local',
                displayField: 'display',
                valueField: 'display',
                publishes: 'value',
                name: 'species',
                listeners: {
                    change: function () {
                        _this.load()
                    }
                }
            });

            var assemblyFieldTag = Ext.create('Ext.form.field.Tag', {
                fieldLabel: 'Assembly',
//            labelWidth: this.labelWidth,
                labelAlign: 'top',
                store: assemblyStore,
                queryMode: 'local',
                displayField: 'display',
                valueField: 'value',
                publishes: 'value',
                name: 'assembly',
                listeners: {
                    change: function () {
                        _this.load()
                    }
                }
            });


            var typeFieldTag = Ext.create('Ext.form.field.Tag', {
                fieldLabel: 'Type',
//            labelWidth: this.labelWidth,
                labelAlign: 'top',
                store: stores.type,
                queryMode: 'local',
                displayField: 'display',
                valueField: 'display',
                publishes: 'value',
                name: 'type',
                listeners: {
                    change: function () {
                        _this.load()
                    }
                }
            });

            var platformFieldTag = Ext.create('Ext.form.field.Tag', {
                fieldLabel: 'Platform',
//            labelWidth: this.labelWidth,
                labelAlign: 'top',
                store: platformStore,
                queryMode: 'local',
                displayField: 'display',
                valueField: 'value',
                publishes: 'value',
                name: 'method',
                listeners: {
                    change: function () {
                        _this.load()
                    }
                }

            });

            var studySearchField = Ext.create('Ext.form.field.Text', {
                fieldLabel: 'Search',
                labelAlign: 'top',
                emptyText: 'search',
                name: 'search',
                listeners: {
                    change: function () {
                        _this.load()
//                        var value = this.getValue();
//                        if (value == "") {
//                            _this.studiesStore.clearFilter();
//                        } else {
//                            var regex = new RegExp(value, "i");
//                            _this.studiesStore.filterBy(function (e) {//
//                                return regex.test(e.get('name')) || regex.test(e.get('description'));
//                            });
//                        }
                    }
                }

            });

            this.columns =[
                            {
                                text: "ID",
                                dataIndex: 'id',
                                flex: 2,
                                // To render a link to FTP
                                renderer: function (value, meta, rec, rowIndex, colIndex, store) {
                                    meta.tdAttr = 'data-qtip="Click to see  more detailed information"';
                                    return value ? Ext.String.format(
                                            '<a href="?dgva-study='+value+'" target="_blank">'+value+'</a>',
                                            value
                                    ) : '';
                                }
                            },
                            {
                                text: "Name",
                                dataIndex: 'name',
                                flex: 4
                            },
                            {
                                text: "Organism",
                                dataIndex: 'speciesScientificName',
                                flex: 3,
                                renderer: function(value, p, record) {
                                    return value ? Ext.String.format(
                                            '<div data-toggle="popover" title="Organism" data-content="And her...">{0}</div>',
                                            value
                                    ) : '';
                                }
                            },
                            {
                                text: "Type",
                                dataIndex: 'type',
                                flex: 3
                            },
                            {
                                text: "Number of Variants",
                                dataIndex: 'numVariants',
                                flex: 3
                            },
                            {
                                text: 'Download',
                                //dataIndex: 'id',
                                xtype: 'templatecolumn',
                                tpl: '<tpl><a href="ftp://ftp.ebi.ac.uk/pub/databases/dgva/{id}_{name}" target="_blank">FTP Download</a></tpl>',
                                flex: 3
                            }

                    ];


            this.paging = Ext.create('Ext.PagingToolbar', {
                store: _this.studiesStore,
                id: _this.id + "_pagingToolbar",
                pageSize: _this.pageSize,
                displayInfo: true,
                displayMsg: 'Studies {0} - {1} of {2}',
                emptyMsg: "No Studies to display"
            });

            this.grid = Ext.create('Ext.grid.Panel', {
                        tbar: this.paging,
                        title: 'Studies found',
                        store: this.studiesStore,
                        header: this.headerConfig,
                        loadMask: true,
//                hideHeaders: true,
//                plugins: 'bufferedrenderer',
                        plugins: [{
                            ptype: 'rowexpander',
                            rowBodyTpl : new Ext.XTemplate(
                                    '<p style="padding: 2px 2px 2px 15px"><b>Platform:</b> {platform}</p>',
//                                    '<p style="padding: 2px 2px 2px 15px"><b>Centre:</b> {center}</p>',
                                    '<p style="padding: 2px 2px 5px 15px"><b>Description:</b> {description}</p>',
                                    {}
                            )
                        }],
                        height: this.height,
                        features: [
                            {ftype: 'summary'}
                        ],
                        viewConfig: {
                            emptyText: 'No studies found',
                            enableTextSelection: true,
                            markDirty: false,
                            listeners: {
                                itemclick: function (este, record) {

                                },
                                itemcontextmenu: function (este, record, item, index, e) {

                                }
                            }
                        },
                        selModel: {
                            listeners: {
                                'selectionchange': function (sm, selectedRecord) {
                                    if (selectedRecord.length) {
                                        var row = selectedRecord[0].data;
                                        _this.trigger("study:select", {sender: _this, args: row});
                                    }
                                }
                            }
                        },
                        columns:this.columns,
                    }
            );


            var submitButton = Ext.create('Ext.button.Button', {
                text: 'Submit',
                handler: function (btn) {
                    console.log(">>>>>>>>>"+panel);
                    var values = panel.getValues();
                    _this.load(values);
                }
            });


            this.leftPanel = Ext.create('Ext.container.Container', {
                flex: 1,
                layout: {
                    type: 'vbox',
                    align: 'stretch'
                },
                defaults: {
                    margin: 5
                },
                items: [
//                submitButton,
                    studySearchField,
                    speciesFieldTag,
//                this.assemblyFieldTag,
//                    typeFieldTag,
//                    platformFieldTag
                ]
            });


            this.rightPanel = Ext.create('Ext.container.Container', {
                flex: 5,
                layout: {
                    type: 'vbox',
                    align: 'stretch'
                },
                defaults: {
                    margin: 5
                },
                items: [this.grid]
            });

            this.formPanel = Ext.create('Ext.form.Panel', {
                title: this.title,
                border: this.border,
                header: this.headerConfig,
                layout: {
                    type: 'hbox',
                    align: 'stretch'
                },
                defaults: {
                    margin: 5
                },
                items: [
                    this.leftPanel,
                    this.rightPanel
                ]
            });


            EvaManager.get({
                host: 'http://wwwdev.ebi.ac.uk/eva/webservices/rest',
                category: 'meta/studies',
                resource: 'stats',
                params: {},
                success: function (response) {
                    try {
                        var statsData = {};
                        var responseStatsData = response.response[0].result[0];
                        for (key in responseStatsData) {
                            var stat = responseStatsData[key];
                            var arr = [];
                            for (key2 in stat) {
                                var obj = {};
                                obj['display'] = key2;
//                                obj['display'] = key2.toLowerCase();
                                obj['count'] = stat[key2];
                                arr.push(obj);
                            }
                            statsData[key] = arr;
                            if (typeof stores[key] !== 'undefined') {
                                stores[key].loadRawData(statsData[key]);
                            }

                        }
                    } catch (e) {
                        console.log(e);
                    }
                }
            });
            this.load();
            return  this.formPanel;
        },

        setLoading: function (loading) {
            this.panel.setLoading(loading);
        },

        update: function () {
            if (this.panel) {
                this.panel.update();
            }
        }

    };




</script>