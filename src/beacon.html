<template>
    <style scoped>
        @import url('//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css');
        .borderless tbody tr td, .borderless thead tr th {
            border: none;
        }
        #resultShow{
            color: #426783;
        }
        .valid{
            color:#25AC0F;
        }
        .invalid{
            color:#CB4437;
        }

        h2{
            color:#378080;
        }

    </style>
    <div class="row">
        <div class="col-md-12">
            <form id="beacon-form">
                <div class="row">
                    <div class="col-md-2 form-group"><p>Chromosome</p></div>
                    <div class="col-md-2 form-group input-group-sm"><div id="chromosome-select"></div></div>
                </div>
                <div class="row">
                    <div class="col-md-2 form-group"><p>Coordinate</p></div>
                    <div class="col-md-2 form-group input-group-sm"><input class="form-control" id="coordinate"  name=coordinate type="text" required/></div>
                </div>
                <div class="row">
                    <div class="col-md-2 form-group"><p>Allele</p></div>
                    <div class="col-md-2 form-group input-group-sm"><input class="form-control" id="allele" name=allele type="text"  required/></div>
                </div>
                <h5>Format Type</h5>
                <div class="row">
                    <div class="col-md-2 form-group"><p>Text</p></div>
                    <div class="col-md-4 form-group input-group-sm"> <input type="radio"  name="formatType" value="text" checked="true"> </div>
                </div>
                <div class="row">
                    <div class="col-md-2 form-group"><p>JSON</p></div>
                    <div class="col-md-4 form-group input-group-sm"> <input type="radio"  name="formatType" value="json"> </div>
                </div>
                <div class="row">
                    <div class="col-md-4 form-group"><span id="refresh-button"></span>&nbsp;&nbsp; <input id="submit" class="btn btn-primary" type="submit"></div>
                </div>
            </form>
        </div>
    </div>
    <div class="row">
        <div class="col-md-5">
            <div id="resultShow"></div><br />
        </div>
    </div>
</template>

<script>
    // This document reference
    var thisDoc = document._currentScript.ownerDocument;

    var beacon = document.registerElement('eva-beacon', {
        prototype: Object.create(HTMLElement.prototype, {
            /*
             * Lifecycle callback methods
             */
            createdCallback: {
                value: function () {
                    var _this = this;

                    //Create a copy of the template node.
                    var template = document.importNode(thisDoc.querySelector('template').content, true);
                    _this.createShadowRoot().appendChild(template);
                }
            },
            attachedCallback: {
                value: function () {
                    var _this = this;
                    var chrSelectDiv =  _this.shadowRoot.querySelector("#chromosome-select");
                    var chrSelectList = document.createElement("select");
                    chrSelectList.setAttribute("id", "chrSelect");
                    chrSelectDiv.appendChild(chrSelectList);
                    for (var i = 1; i < 25; i++) {
                        var option = document.createElement("option");
                        if(i == 23){
                            option.setAttribute("value", i);
                            option.text = 'Chr X';
                        }
                        else if(i == 24){
                            option.setAttribute("value", i);
                            option.text = 'Chr Y';
                        }else{
                            option.setAttribute("value", i);
                            option.text = 'Chr '+i;
                        }

                        chrSelectList.appendChild(option);
                    }


                    var chromAttr = _this.getAttribute('chrom');
                    var coordinateAttr  = _this.getAttribute('coordinate');
                    var alleleAttr  = _this.getAttribute('allele');
                    if(chromAttr && coordinateAttr && alleleAttr){
                        _this.shadowRoot.querySelector('#chrSelect').value  =  chromAttr;
                        _this.shadowRoot.querySelector('#coordinate').value  =  coordinateAttr;
                        _this.shadowRoot.querySelector('#allele').value  =  alleleAttr;
                    }

                    var submit = _this.shadowRoot.querySelector('#beacon-form');
                    submit.addEventListener('submit', function(eve) {
                        var chr = _this.shadowRoot.querySelector('#chrSelect').value;
                        var coordinate =_this.shadowRoot.querySelector('#coordinate').value;
                        var allele = _this.shadowRoot.querySelector('#allele').value;
                        if(_this.shadowRoot.querySelector('input[name="formatType"]:checked')){
                            var formatType = _this.shadowRoot.querySelector('input[name="formatType"]:checked').value;
                        }
                        var region = chr+':'+coordinate+':'+ allele;
                        var data= {};
                        data.formatType = formatType;
                        data.result = 'test';
                        if(chr && coordinate &&  allele){
                            EvaManager.get({
                            host: 'http://wwwdev.ebi.ac.uk/eva/webservices/rest',
                            category: 'variants',
                            resource: 'exists',
                            query:region,
                            success: function (response) {
                                    try {
                                        data.result = response.response[0].result;
                                    } catch (e) {
                                        console.log(e);
                                    }
                                _this.renderResultData(data, region);
                                }
                            });
                        }
                        eve.preventDefault();

                    }, true);

                }
            },
            renderResultData: {
                value: function (data,region) {
                   var _this = this;
                   var resultData
                   var cssClass;

                   if(data.result == 'true'){
                       cssClass = 'valid';
                   }else{
                       cssClass = 'invalid';
                   }
                   var _region = region.split(":");
                    if(data.formatType == 'json'){
                       _resultData = {query:{chrom:_region[0],pos:_region[1],allele:_region[2]},exist:data.result};
                       resultData ='<h4>Result:</h4>'+ JSON.stringify(_resultData);
                   }else{
                       resultData = '<h4>Result:</h4><table  class="table table-bordered">' +
                                     '<tr><td>Chromosome</td><td>'+_region[0]+'</td></tr>'+
                                     '<tr><td>Coordinate</td><td>'+_region[1]+'</td></tr>'+
                                     '<tr><td>Allele</td><td>'+_region[2]+'</td></tr>'+
                                     '<tr><td>Exist</td><td class="'+cssClass+'">'+data.result+'</td></tr>'+
                                    '</table>'
                   }
                    var showResultDiv =  _this.shadowRoot.querySelector("#resultShow");
                    showResultDiv.innerHTML = "";
                    var resultElDiv =  document.createElement("div");
                    resultElDiv.innerHTML = resultData;
                    showResultDiv.appendChild(resultElDiv);

                    var refreshBtnDiv =  _this.shadowRoot.querySelector("#refresh-button");
                    refreshBtnDiv.innerHTML = "";
                    var refreshBtnEl =  document.createElement("button");
                    refreshBtnEl.type = "submit";
                    refreshBtnEl.textContent = "Reset";
                    refreshBtnEl.className = "btn btn-primary";
                    refreshBtnEl.id = "refresh";
                    refreshBtnDiv.appendChild(refreshBtnEl);

                    var refresh = _this.shadowRoot.querySelector('#refresh');
                    refresh.addEventListener('click', function(eve) {
                        eve.preventDefault();
                        showResultDiv.innerHTML = "";
                        _this.shadowRoot.getElementById("beacon-form").reset();

                    }, true);

                }
            }

        })
    });




</script>