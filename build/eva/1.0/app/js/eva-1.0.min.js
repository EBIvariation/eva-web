function EventManager(){_.extend(this,Backbone.Events)}function VariantWidget(a){_.extend(this,Backbone.Events),this.location="",_.extend(this,a)}function GeneWidget(a){_.extend(this,Backbone.Events),this.location="",_.extend(this,a)}function VariantGenotypeWidget(a){_.extend(this,Backbone.Events),this.location="",_.extend(this,a)}var evaApp=angular.module("evaApp",["ui.bootstrap","ebiApp","highcharts-ng","ebiVar.Services.Metadata","homeWidgetModule","variantWidgetModule","checklist-model","geneWidgetModule","ui.router","duScroll"]);METADATA_HOST="http://www.ebi.ac.uk/eva/webservices/rest",METADATA_VERSION="v1",CELLBASE_HOST="http://www.ebi.ac.uk/cellbase/webservices/rest",CELLBASE_VERSION="v3",-1===window.location.host.indexOf("www.ebi.ac.uk")&&(METADATA_HOST="http://wwwint.ebi.ac.uk/eva/webservices/rest",METADATA_VERSION="v1",CELLBASE_HOST="http://ws-beta.bioinfo.cipf.es/cellbase-staging/rest",CELLBASE_VERSION="latest"),angular.module("ebiApp",[]).directive("ebiHeader",function(){return{restrict:"A",replace:!0,transclude:!0,templateUrl:"views/header.html",controller:function(){}}}).directive("ebiFooter",function(){return{restrict:"A",replace:!0,transclude:!0,templateUrl:"views/footer.html",controller:function(){}}});var variationCtrl=evaApp.controller("variationBrowserCtrl",["$scope","$rootScope","ebiVarMetadataService",function(a,b,c){function d(b){if(b){var d=CELLBASE_HOST+"/"+CELLBASE_VERSION+"/hsa/feature/gene/"+a.gene+"/info?of=json",e=c.fetchData(d),f=e[0][0].chromosome+":"+e[0][0].start+"-"+e[0][0].end;a.location=f}}a.searchboxValue,a.search=function(){var b=window.location.origin+window.location.pathname+"?variantID="+a.searchboxValue;window.location.href=b},eventManager.on("gene:search variant:search",function(){d(a.gene)}),$(function(){$("#summaryChart").tooltip()}),a.statisticsClass="glyphicon glyphicon-chevron-right",a.showStatitsicsState,a.searchVariants=function(){eventManager.trigger("variant:search")},a.reloadVariants=function(){a.location=e,eventManager.trigger("variant:search")},a.searchGenes=function(){eventManager.trigger("gene:search")},a.showStatitsics=function(){this.showStatitsicsState=!this.showStatitsicsState,this.statisticsClass=this.showStatitsicsState?"glyphicon glyphicon-chevron-down":"glyphicon glyphicon-chevron-right"};var e="21:9411240-9411260";a.location=e,a.studies=[{name:"1000g",leaf:!0,checked:!1,iconCls:"no-icon"},{name:"GoNL",leaf:!0,checked:!1,iconCls:"no-icon"},{name:"EVS",leaf:!0,checked:!1,iconCls:"no-icon"}],a.consequenceTypes=[{name:"UTR Variant",cls:"folder",expanded:!0,leaf:!1,children:[{acc:"SO:0001623",name:"5_prime_UTR_variant",description:"A UTR variant of the 5' UTR",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001624",name:"3_prime_UTR_variant",description:"A UTR variant of the 3' UTR",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001819",name:"synonymous_variant",description:"A sequence variant where there is no resulting change to the encoded amino acid",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001567",name:"stop_retained_variant",description:"A sequence variant where at least one base in the terminator codon is changed, but the terminator remains",leaf:!0,checked:!1,iconCls:"no-icon"}]},{name:"Feature Variant",cls:"folder",expanded:!0,leaf:!1,children:[{acc:"SO:0001907",name:"feature_elongation",description:"A sequence variant that causes the extension of a genomic feature, with regard to the reference sequence",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001906",name:"feature_truncation",description:"A sequence variant that causes the reduction of a genomic feature, with regard to the reference sequence",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001627",name:"intron_variant",description:"A transcript variant occurring within an intron",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001628",name:"intergenic_variant",description:"A sequence variant located in the intergenic region, between genes",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001566",name:"regulatory_region_variant",description:"A sequence variant located within a regulatory region",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001894",name:"regulatory_region_ablation",description:"A feature ablation whereby the deleted region includes a regulatory region",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001891",name:"regulatory_region_amplification",description:"A feature amplification of a region containing a regulatory region",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001587",name:"stop_gained",description:"A sequence variant whereby at least one base of a codon is changed, resulting in a premature stop codon, leading to a shortened transcript",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001589",name:"frameshift_variant",description:"A sequence variant which causes a disruption of the translational reading frame, because the number of nucleotides inserted or deleted is not a multiple of three",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001578",name:"stop_lost",description:"A sequence variant where at least one base of the terminator codon (stop) is changed, resulting in an elongated transcript",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001782",name:"TF_binding_site_variant",description:"A sequence variant located within a transcription factor binding site",leaf:!0,checked:!1,iconCls:"no-icon"}]},{name:"Inframe Variant",cls:"folder",expanded:!0,leaf:!1,children:[{acc:"SO:0001821",name:"inframe_insertion",description:"An inframe non synonymous variant that inserts bases into in the coding sequence",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001822",name:"inframe_deletion",description:"An inframe non synonymous variant that deletes bases from the coding sequence",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001626",name:"incomplete_terminal_codon_variant",description:"A sequence variant where at least one base of the final codon of an incompletely annotated transcript is changed",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001582",name:"initiator_codon_variant",description:"A codon variant that changes at least one base of the first codon of a transcript",leaf:!0,checked:!1,iconCls:"no-icon"}]},{name:"Transcript Variant",cls:"folder",expanded:!0,leaf:!1,children:[{acc:"SO:0001620",name:"mature_miRNA_variant",description:"A transcript variant located with the sequence of the mature miRNA",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001792",name:"non_coding_exon_variant",description:"A sequence variant that changes non-coding exon sequence",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001619",name:"nc_transcript_variant",description:"A transcript variant of a non coding RNA",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001621",name:"NMD_transcript_variant",description:"A variant in a transcript that is the target of NMD",leaf:!0,checked:!1,iconCls:"no-icon"}]},{name:"Splice Variant",cls:"folder",expanded:!0,leaf:!1,children:[{acc:"SO:0001575",name:"splice_donor_variant",description:"A splice variant that changes the 2 base region at the 5' end of an intron",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001574",name:"splice_acceptor_variant",description:"A splice variant that changes the 2 base region at the 3' end of an intron",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001630",name:"splice_region_variant",description:"A sequence variant in which a change has occurred within the region of the splice site, either within 1-3 bases of the exon or 3-8 bases of the intron",leaf:!0,checked:!1,iconCls:"no-icon"}]},{name:"Structural Variant",cls:"folder",expanded:!0,leaf:!1,children:[{acc:"SO:0001889",name:"transcript_amplification",description:"A feature amplification of a region containing a transcript",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001893",name:"transcript_ablation",description:"A feature ablation whereby the deleted region includes a transcript feature",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001895",name:"TFBS_ablation",description:"A feature ablation whereby the deleted region includes a transcription factor binding site",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001892",name:"TFBS_amplification",description:"A feature amplification of a region containing a transcription factor binding site",leaf:!0,checked:!1,iconCls:"no-icon"}]},{name:"Intergenic Variant",cls:"folder",expanded:!0,leaf:!1,children:[{acc:"SO:0001631",name:"upstream_gene_variant",description:"A sequence variant located 5' of a gene",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001632",name:"downstream_gene_variant",description:"A sequence variant located 3' of a gene",leaf:!0,checked:!1,iconCls:"no-icon"}]},{acc:"SO:0001583",name:"missense_variant",description:"A sequence variant, that changes one or more bases, resulting in a different amino acid sequence but where the length is preserved",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001580",name:"coding_sequence_variant",description:"A sequence variant that changes the coding sequence",leaf:!0,checked:!1,iconCls:"no-icon"}],a.variationClasses=[{name:"Variation",cls:"folder",expanded:!0,leaf:!1,children:[{acc:"SO:0001483",name:"SNV",description:"SNVs are single nucleotide positions in genomic DNA at which different sequence alternatives exist.",call:"Variation",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:1000032",name:"indel",description:"A sequence alteration which included an insertion and a deletion, affecting 2 or more bases.",call:"Variation",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:1000002",name:"substitution",description:"A sequence alteration where the length of the change in the variant is the same as that of the reference.",call:"Variation",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0000667",name:"insertion",description:"The sequence of one or more nucleotides added between two adjacent nucleotides in the sequence.",call:"Variation",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0001059",name:"sequence_alteration",description:"A sequence_alteration is a sequence_feature whose extent is the deviation from another sequence.",call:"Variation",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0000705",name:"tandem_repeat",description:"Two or more adjcent copies of a region (of length greater than 1).",call:"Variation",leaf:!0,checked:!1,iconCls:"no-icon"},{acc:"SO:0000159",name:"deletion",description:"The point at which one or more contiguous nucleotides were excised.",call:"Variation",leaf:!0,checked:!1,iconCls:"no-icon"}]},{acc:"SO:0000051",name:"probe",description:"A DNA sequence used experimentally to detect the presence or absence of a complementary nucleic acid.",call:"CNV probe",leaf:!0,checked:!1,iconCls:"no-icon"}],a.barChart={options:{chart:{type:"bar"},plotOptions:{series:{cursor:"pointer",point:{events:{click:function(){console.log(this.series.color)}}}}}},series:[{data:a.data}],title:{text:a.message},loading:!1,credits:{enabled:!1}}}]);angular.module("homeWidgetModule",[]).directive("homeWidget",function(){return{restrict:"E",replace:!0,transclude:!0,templateUrl:"views/home.html",link:function(a){a.hometest="bla bla",!function(a,b,c){var d,e=a.getElementsByTagName(b)[0],f=/^http:/.test(a.location)?"http":"https";a.getElementById(c)||(d=a.createElement(b),d.id=c,d.src=f+"://platform.twitter.com/widgets.js",e.parentNode.insertBefore(d,e))}(document,"script","twitter-wjs")}}});var genomeViewer;angular.module("variantWidgetModule",[]).directive("variantWidget",function(){return{restrict:"E",replace:!0,transclude:!0,templateUrl:"views/variation-browser-view.html",link:function(a){function b(a){if(a.length>0){var b=[];return Ext.Array.each(a,function(a){b.push(a.get("name"))}),b.join()}}function c(a){a.store.getRootNode().cascadeBy(function(){this.set("checked",!1)})}var d,e,f;a.variantTableId="variantBrowserTable",a.variantEffectTableId="variantEffectTable",a.variantFilesTableId="variantFilesTable",a.variantStatsViewId="variantStatsView",a.variantStatsChartId="variantStatsChart",a.variantGenoTypeTableId="variantGenoTypeTable",a.variantGenomeViewerId="variant-browser-gv",a.variantBrowserSubTabsId="variantSubTabs",a.studiesTreeId="studiesTreeID",a.consequenceTypeTreeId="consequenceTypeTreeID",a.variationClassesTreeId="variationClassesTreeID",jQuery('#topMenuTab a[data-toggle="tab"]').on("shown.bs.tab",function(b){var c;c=new VariantWidget({});var g=[];g.id=a.studiesTreeId,g.data=a.studies;var h=[];h.id=a.consequenceTypeTreeId,h.data=a.consequenceTypes;var i=[];i.id=a.variationClassesTreeId,i.data=a.variationClasses,"variationLi"===b.target.parentElement.id&&(0===jQuery("#"+a.studiesTreeId).contents().length&&(e=c.createTreePanel(g)),0===jQuery("#"+a.consequenceTypeTreeId).contents().length&&(d=c.createTreePanel(h)),0===jQuery("#"+a.variationClassesTreeId).contents().length&&(f=c.createTreePanel(i)))}),a.clearVariants=function(){a.location="",a.gene="",console.log(e.store.getRootNode()),c(e),c(d),c(f),eventManager.trigger("variant:search")},eventManager.on("variant:search",function(){{var c=(b(e.getView().getChecked()),b(d.getView().getChecked()));b(f.getView().getChecked())}a.CTfilter=c?"&effect="+c:"",a.filters=a.CTfilter;var g;g=new VariantWidget({variantTableID:a.variantTableId,variantEffectTableID:a.variantEffectTableId,variantFilesTableID:a.variantFilesTableId,variantStatsViewID:a.variantStatsViewId,variantStatsChartID:a.variantStatsChartId,variantGenoTypeTableID:a.variantGenoTypeTableId,location:a.location,filters:a.filters,variantGenomeViewerID:a.variantGenomeViewerId,variantSubTabsID:a.variantBrowserSubTabsId}),g.draw(),genomeViewer.rendered||(genomeViewer.render(),genomeViewer.draw(),genomeViewer.addTrack(j),genomeViewer.addOverviewTrack(n));var h=new Region;h.parse(a.location),genomeViewer.setRegion(h)});var g=new Region({chromosome:"13",start:32889611,end:32889611}),h={text:"Species",items:[{text:"Vertebrates",items:[{text:"Homo sapiens",assembly:"GRCh37.p10",region:{chromosome:"13",start:32889611,end:32889611},chromosomes:["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","X","Y","MT"],url:"ftp://ftp.ensembl.org/pub/release-71/"},{text:"Mus musculus",assembly:"GRCm38.p1",region:{chromosome:"1",start:18422009,end:18422009},chromosomes:["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","X","Y","MT"],url:"ftp://ftp.ensembl.org/pub/release-71/"}]}]},i=h.items[0].items[0];genomeViewer=new GenomeViewer({targetId:"variant-browser-gv",region:g,availableSpecies:h,species:i,sidePanel:!1,autoRender:!1,border:!0,resizable:!0,karyotypePanelConfig:{collapsed:!1,collapsible:!0},chromosomePanelConfig:{collapsed:!1,collapsible:!0},handlers:{"region:change":function(a){console.log(a)}}});var j=[],k=new SequenceTrack({targetId:null,id:1,height:30,visibleRegionSize:200,renderer:new SequenceRenderer,dataAdapter:new SequenceAdapter({category:"genomic",subCategory:"region",resource:"sequence",species:genomeViewer.species})});j.push(k);var l=new GeneTrack({targetId:null,id:2,title:"Gene",minHistogramRegionSize:2e7,maxLabelRegionSize:1e7,minTranscriptRegionSize:2e5,height:140,renderer:new GeneRenderer,dataAdapter:new CellBaseAdapter({category:"genomic",subCategory:"region",resource:"gene",species:genomeViewer.species,params:{exclude:"transcripts.tfbs,transcripts.xrefs,transcripts.exons.sequence"},cacheConfig:{chunkSize:1e5}})});j.push(l);var m=new FeatureRenderer(FEATURE_TYPES.gene);m.on({"feature:click":function(a){console.log(a)}});var n=new FeatureTrack({targetId:null,id:2,minHistogramRegionSize:2e7,maxLabelRegionSize:1e7,height:100,renderer:m,dataAdapter:new CellBaseAdapter({category:"genomic",subCategory:"region",resource:"gene",params:{exclude:"transcripts"},species:genomeViewer.species,cacheConfig:{chunkSize:1e5}})});this.snp=new FeatureTrack({targetId:null,id:4,title:"SNP",featureType:"SNP",minHistogramRegionSize:12e3,maxLabelRegionSize:3e3,height:100,renderer:new FeatureRenderer(FEATURE_TYPES.snp),dataAdapter:new CellBaseAdapter({category:"genomic",subCategory:"region",resource:"snp",params:{exclude:"transcriptVariations,xrefs,samples"},species:genomeViewer.species,cacheConfig:{chunkSize:1e4}})}),j.push(this.snp)}}}).directive("variantView",function(){return{restrict:"E",replace:!0,transclude:!0,templateUrl:"views/variant-view.html",controller:function(a,b){var c=getUrlParameters("");if(c.value){var d=METADATA_HOST+"/"+METADATA_VERSION+"/variants/"+c.value+"/info",e=b.fetchData(d);if(e.response.numResults){a.variant=c.value,a.variantInfoData=e.response.result[0],a.variantFilesData=e.response.result[0].files[0],console.log(a.variantInfoData);var f=a.variantInfoData.chr+":"+a.variantInfoData.start+":"+a.variantInfoData.ref+":"+a.variantInfoData.alt,g=CELLBASE_HOST+"/"+CELLBASE_VERSION+"/hsa/genomic/variant/"+f+"/consequence_type?of=json",h=b.fetchData(g),i=[];$.each(h,function(a,b){var c=b.consequenceType;i[c]||(i[c]=[]),i[c].push({featureId:b.featureId,featureType:b.featureType,featureChromosome:b.featureChromosome,featureStart:b.featureStart,featureEnd:b.featureEnd,consequenceTypeType:b.consequenceTypeType})});var j=new Array;for(key in i)console.log(i[key][0].consequenceTypeType),j.push({id:key,name:i[key][0].consequenceTypeType,data:i[key]});a.effectsData=j,a.effects="-",a.showEffectsState=!0,console.log(a.effectsData),a.showEffects=function(){this.showEffectsState=!this.showEffectsState,this.effects=this.showEffectsState?"-":"+"}}}},link:function(){}}}),angular.module("geneWidgetModule",[]).directive("geneWidget",function(){return{restrict:"E",replace:!0,transclude:!0,templateUrl:"views/gene-browser-view.html",link:function(a){a.geneView="sdasfd",a.geneTableId="geneBrowserTable",eventManager.on("gene:search",function(){var b;b=new GeneWidget({geneTableID:a.geneTableId,gene:a.gene}),b.draw()})}}}),VariantWidget.prototype={draw:function(){this._createVariantPanel()},createTreePanel:function(a){Ext.require(["Ext.tree.*","Ext.data.*","Ext.window.MessageBox"]),Ext.define("Tree Model",{extend:"Ext.data.Model",fields:[{name:"name",type:"string"},{name:"acc",type:"string"}]});var b=Ext.create("Ext.data.TreeStore",{model:"Tree Model",proxy:{type:"memory",data:a.data,reader:{type:"json"}}}),c=Ext.create("Ext.tree.Panel",{header:!1,border:!1,autoWidth:!0,autoHeight:!0,renderTo:a.id,collapsible:!1,useArrows:!0,rootVisible:!1,store:b,frame:!1,hideHeaders:!0,bodyBorder:!1,columns:[{xtype:"treecolumn",flex:2,sortable:!1,dataIndex:"name",renderer:function(a,b,c){var d="http://www.sequenceontology.org/miso/current_release/term/"+c.data.acc;return a+" <a href="+d+' target="_blank">'+c.data.acc+"</a>"}}],dockedItems:[{xtype:"toolbar",ui:"footer",frame:!1,items:[{xtype:"button",text:"Select All",handler:function(){c.getRootNode().cascadeBy(function(){this.hasChildNodes()?this.set("checked",null):this.set("checked",!0)})}},{xtype:"button",text:"Clear",handler:function(){c.getRootNode().cascadeBy(function(){this.hasChildNodes()?this.set("checked",null):this.set("checked",!1)})}}]}],listeners:{itemclick:function(a,b){if(b&&b.hasChildNodes()){var c=b.firstChild.data.checked;b.cascadeBy(function(){0==c?this.set("checked",!0):this.set("checked",!1),b.set("checked",null)})}}}});return c},_createVariantPanel:function(){this.grid=this._createBrowserGrid()},_createBrowserGrid:function(){jQuery("#"+this.variantTableID+" div").length&&jQuery("#"+this.variantTableID+" div").remove();var a=this;Ext.require(["Ext.grid.*","Ext.data.*","Ext.util.*","Ext.state.*"]),Ext.define(this.variantTableID,{extend:"Ext.data.Model",fields:[{name:"id",type:"string"},{name:"type",type:"string"},{name:"chr",type:"int"},{name:"start",type:"int"},{name:"end",type:"int"},{name:"length",type:"int"},{name:"ref",type:"string"},{name:"alt",type:"string"},{name:"chunkIds",type:"auto"},{name:"hgvsType",type:"auto",mapping:"hgvs[0].type"},{name:"hgvsName",type:"auto",mapping:"hgvs[0].name"}],idProperty:"id"}),Ext.QuickTips.init(),Ext.state.Manager.setProvider(Ext.create("Ext.state.CookieProvider")),Ext.Ajax.useDefaultXhrHeader=!1,Ext.Ajax.cors=!0;var b=METADATA_HOST+"/"+METADATA_VERSION+"/segments/"+a.location+"/variants?exclude=files,chunkIds"+a.filters;a.vbStore=Ext.create("Ext.data.JsonStore",{autoLoad:!0,autoSync:!0,autoLoad:{start:0,limit:10},pageSize:10,remoteSort:!0,model:this.variantTableID,proxy:{type:"ajax",url:b,startParam:"skip",limitParam:"limit",reader:{type:"json",root:"response.result",totalProperty:"response.numTotalResults"}}});var c="";return a.vbGrid=Ext.create("Ext.grid.Panel",{header:!1,store:a.vbStore,stateful:!0,collapsible:!0,multiSelect:!0,columns:{items:[{text:"Chromosome",sortable:!0,dataIndex:"chr"},{text:"Start",sortable:!0,dataIndex:"start"},{text:"End",sortable:!0,dataIndex:"end"},{text:"ID",sortable:!1,dataIndex:"id",xtype:"templatecolumn",tpl:'<a href="?variantID={id}" target="_blank">{id}</a>'},{text:"Type",sortable:!0,dataIndex:"type"},{text:"REF/ALT",sortable:!0,dataIndex:"ref",xtype:"templatecolumn",tpl:'<tpl if="ref">{ref}<tpl else>-</tpl>/<tpl if="alt">{alt}<tpl else>-</tpl>'},{text:"HGVS Name",sortable:!0,dataIndex:"hgvsName"}],defaults:{flex:1,align:"center"}},height:350,autoWidth:!0,autoScroll:!1,renderTo:this.variantTableID,viewConfig:{enableTextSelection:!0,forceFit:!0},deferredRender:!1,dockedItems:[{xtype:"pagingtoolbar",store:a.vbStore,dock:"bottom",displayInfo:!0}],listeners:{itemclick:function(){var b=a._getSelectedData();a._updateEffectGrid(b.position),a._updateFilesGrid(b.variantId),a._createGenotypeGrid(b.variantId);var c=jQuery("#"+a.variantSubTabsID+" .active").attr("id");if(c===a.variantGenomeViewerID+"Li"){var d=new Region;d.parse(b.location),genomeViewer.setRegion(d)}},render:function(b){b.store.on("load",function(){if(a.vbStore.getCount()>0){c=1;b.getSelectionModel().select(0),a.gridFiles=a._createFilesGrid(),a.gridEffect=a._createEffectGrid(),a.gridStats=a._createStatesGrid(),b.fireEvent("itemclick",b,b.getSelectionModel().getLastSelected())}else c=0,a._clearGrid()})}}}),jQuery("#"+a.variantSubTabsID+' a[data-toggle="tab"]').on("shown.bs.tab",function(b){if(1===c){var d=(a.vbGrid,a._getSelectedData());if(console.log(b.target.parentElement.id),b.target.parentElement.id===a.variantEffectTableID+"Li")a.gridEffect=a._createEffectGrid(),a._updateEffectGrid(d.position);else if(b.target.parentElement.id===a.variantFilesTableID+"Li")a.gridFiles=a._createFilesGrid(),a.gridStats=a._createStatesGrid(),a._updateFilesGrid(d.variantId);else if(b.target.parentElement.id===a.variantGenoTypeTableID+"Li")a._createGenotypeGrid(d.variantId);else if(b.target.parentElement.id===a.variantGenomeViewerID+"Li"){var e=new Region;e.parse(d.location),genomeViewer.setRegion(e)}}else a._clearGrid()}),a.vbGrid},_createGenotypeGrid:function(a){var b=this,c=new VariantGenotypeWidget({url:METADATA_HOST+"/"+METADATA_VERSION+"/variants/"+a+"/info",render_id:b.variantGenoTypeTableID,title:"Genotypes",pageSize:10});c.draw()},_updateFilesGrid:function(a){var b=this,c=a,d=METADATA_HOST+"/"+METADATA_VERSION+"/variants/"+c+"/info",e=this._fetchData(d);e.response.result?(b.gridFiles.getStore().loadData(e.response.result),b.gridFiles.setHeight(150),b._updateStatsGrid(e.response.result)):b.gridFiles.getStore().removeAll()},_updateEffectGrid:function(a){var b=this,c=a,d=CELLBASE_HOST+"/"+CELLBASE_VERSION+"/hsa/genomic/variant/"+c+"/consequence_type?of=json",e=b._fetchData(d);e.length>0?this.gridEffect.getStore().loadData(e):this.gridEffect.getStore().removeAll()},_createEffectGrid:function(){jQuery("#"+this.variantEffectTableID+" div").length>0&&jQuery("#"+this.variantEffectTableID+" div").remove();var a=this;return Ext.define(a.variantEffectTableID,{extend:"Ext.data.Model",fields:[{name:"chromosome"},{name:"position"},{name:"snpId"},{name:"consequenceType"},{name:"aminoacidChange"},{name:"geneId"},{name:"transcriptId"},{name:"featureId"},{name:"featureName"},{name:"featureType"},{name:"featureBiotype"}]}),a.veStore=Ext.create("Ext.data.JsonStore",{model:a.variantEffectTableID,data:[]}),a.veGrid=Ext.create("Ext.grid.Panel",{header:!1,store:a.veStore,stateful:!0,collapsible:!0,multiSelect:!0,columns:{items:[{text:"position",sortable:!1,dataIndex:"position",xtype:"templatecolumn",tpl:"{chromosome}:{position}"},{text:"snpId",sortable:!0,dataIndex:"snpId"},{text:"consequenceType",sortable:!0,dataIndex:"consequenceType",renderer:function(a){var b='<a href="http://www.sequenceontology.org/miso/current_release/term/'+a+'" target="_blank">'+a+"</a>";return b}},{text:"aminoacidChange",sortable:!0,dataIndex:"aminoacidChange"},{text:"geneId",sortable:!0,dataIndex:"geneId",renderer:function(a){var b='<a href="http://www.ensembl.org/Homo_sapiens/Location/View?g='+a+'" target="_blank">'+a+"</a>";return b}},{text:"transcriptId",sortable:!0,dataIndex:"transcriptId",renderer:function(a){var b='<a href="http://www.ensembl.org/Homo_sapiens/Location/View?t='+a+'" target="_blank">'+a+"</a>";return b}},{text:"featureId",sortable:!0,dataIndex:"featureId"},{text:"featureName",sortable:!0,dataIndex:"featureName"},{text:"featureType",sortable:!0,dataIndex:"featureType"},{text:"featureBiotype",sortable:!0,dataIndex:"featureBiotype",resizable:!1}],defaults:{flex:1,align:"center"}},height:350,title:"Effects",deferredRender:!1,renderTo:this.variantEffectTableID,viewConfig:{enableTextSelection:!0}}),a.veGrid},_createFilesGrid:function(){jQuery("#"+this.variantFilesTableID+" div").length>0&&jQuery("#"+this.variantFilesTableID+" div").remove();var a=this;Ext.define(a.variantFilesTableID,{extend:"Ext.data.Model",fields:[{name:"files",type:"auto"}]});METADATA_HOST+"/"+METADATA_VERSION+"/segments/"+a.location+"/variants?exclude=effects,chunkIds";return a.vfStore=Ext.create("Ext.data.JsonStore",{model:a.variantFilesTableID,data:[]}),a.vfGrid=Ext.create("Ext.grid.Panel",{header:!1,store:a.vfStore,stateful:!0,collapsible:!0,multiSelect:!0,columns:{items:[{text:"FileID",sortable:!1,dataIndex:"files",renderer:function(a){return a[0].fileId}},{text:"StudyID",sortable:!1,dataIndex:"files",renderer:function(a){return a[0].studyId}},{text:"Attributes",columns:[{text:"QUAL",sortable:!1,dataIndex:"files",renderer:function(a){return a[0].attributes.QUAL}},{text:"FILTER",sortable:!1,dataIndex:"files",renderer:function(a){return a[0].attributes.FILTER}},{text:"AVGPOST",sortable:!1,dataIndex:"files",hidden:!0,renderer:function(a){return a[0].attributes.AVGPOST}},{text:"RSQ",sortable:!1,dataIndex:"files",hidden:!0,renderer:function(a){return a[0].attributes.RSQ}},{text:"LDAF",sortable:!1,dataIndex:"files",hidden:!0,renderer:function(a){return a[0].attributes.LDAF}},{text:"ERATE",sortable:!1,dataIndex:"files",renderer:function(a){return a[0].attributes.ERATE}},{text:"AN",sortable:!1,dataIndex:"files",renderer:function(a){return a[0].attributes.AN}},{text:"VT",sortable:!1,dataIndex:"files",hidden:!0,renderer:function(a){return a[0].attributes.VT}},{text:"AA",sortable:!1,dataIndex:"files",renderer:function(a){return a[0].attributes.AA}},{text:"THETA",sortable:!1,dataIndex:"files",hidden:!0,renderer:function(a){return a[0].attributes.THETA}},{text:"AC",sortable:!1,dataIndex:"files",renderer:function(a){return a[0].attributes.AC}},{text:"SNPSOURCE",sortable:!1,dataIndex:"files",renderer:function(a){return a[0].attributes.SNPSOURCE}},{text:"AF",sortable:!1,dataIndex:"files",renderer:function(a){return a[0].attributes.AF}},{text:"ASN_AF",sortable:!1,dataIndex:"files",hidden:!0,renderer:function(a){return a[0].attributes.ASN_AF}},{text:"AMR_AF",sortable:!1,dataIndex:"files",hidden:!0,renderer:function(a){return a[0].attributes.AMR_AF}},{text:"AFR_AF",sortable:!1,dataIndex:"files",hidden:!0,renderer:function(a){return a[0].attributes.AFR_AF}},{text:"EUR_AF",sortable:!1,dataIndex:"files",hidden:!0,renderer:function(a){return a[0].attributes.EUR_AF}}],defaults:{align:"center"}}],defaults:{flex:1,align:"center"}},height:350,title:"Files",renderTo:this.variantFilesTableID,viewConfig:{enableTextSelection:!0},deferredRender:!1}),a.vfGrid},_createStatesGrid:function(){jQuery("#"+this.variantStatsViewID+" div").length>0&&jQuery("#"+this.variantStatsViewID+" div").remove();var a=this,b=Ext.create("Ext.Panel",{header:!1,renderTo:a.variantStatsViewID,title:"Stats",height:330,html:"<p><i></i></p>"});return b},_updateStatsGrid:function(a){var b=this;tpl=Ext.create("Ext.XTemplate",'<tpl for="files">','<tpl for="stats">','<table class="grid-table">',"<tr>","<td>MAF</td>","<td>{maf}</td>","</tr>","<tr>","<td>MGF</td>","<td>{mgf}</td>","</tr>","<tr>","<td>Allele MAF</td>","<td>{alleleMaf}</td>","</tr>","<tr>","<td>Genotype MAF</td>","<td>{genotypeMaf}</td>","</tr>","<tr>","<td>miss Allele</td>","<td>{missAllele}</td>","</tr>","<tr>","<td>miss Genotypes</td>","<td>{missGenotypes}</td>","</tr>","<tr>","<td>Mendel Err</td>","<td>{missGenotypes}</td>","</tr>","<tr>","<td>Cases Percent Dominant</td>","<td>{casesPercentDominant}</td>","</tr>","<tr>","<td>Controls Percent Dominant</td>","<td>{controlsPercentDominant}</td>","</tr>","<tr>","<td>Cases Percent Recessive</td>","<td>{controlsPercentDominant}</td>","</tr>","<tr>","<td>Controls Percent Recessive</td>","<td>{controlsPercentRecessive}</td>","</tr>","</table>","<p>{[this._drawChart(values.genotypeCount)]}</p>","</tpl>","</tpl>",{_drawChart:function(a){var c=[];for(key in a)c.push([key,a[key]]);a.title="Genotype Count",a.data=c,b._statsPieChart(a)}}),tpl.overwrite(b.gridStats.body,a[0]),b.gridStats.doComponentLayout()},_statsPieChart:function(a){{var b=this;new Highcharts.Chart({chart:{renderTo:b.variantStatsChartID,plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1},title:{text:a.title},tooltip:{pointFormat:"{series.name}: <b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,color:"#000000",connectorColor:"#000000",format:"<b>{point.name}</b>: {point.percentage:.1f} %"}}},series:[{type:"pie",name:a.title,data:a.data}],credits:{enabled:!1}})}},_getSelectedData:function(){var a=this,b=[],c=a.vbGrid.getSelectionModel().selected.items[0].data,c=a.vbGrid.getSelectionModel().selected.items[0].data;return b.variantId=c.id,b.position=c.chr+":"+c.start+":"+c.ref+":"+c.alt,b.location=c.chr+":"+c.start+"-"+c.end,b},_fetchData:function(a){var b;return $.ajax({url:a,async:!1,dataType:"json",success:function(a){b=a},error:function(){b=""}}),b},_clearGrid:function(){var a=this;a.gridFiles=a._createFilesGrid(),a.gridEffect=a._createEffectGrid(),a.gridStats=a._createStatesGrid(),a._createGenotypeGrid()}},GeneWidget.prototype={draw:function(){this._createGenePanel()},_createGenePanel:function(){this.grid=this._createBrowserGrid()},_createBrowserGrid:function(){jQuery("#"+this.geneTableID+" div").length&&jQuery("#"+this.geneTableID+" div").remove();var a=this;Ext.require(["Ext.grid.*","Ext.data.*","Ext.util.*","Ext.state.*"]),Ext.define(this.geneTableID,{extend:"Ext.data.Model",fields:[{name:"id",type:"string"},{name:"type",type:"string"},{name:"chr",type:"int"},{name:"start",type:"int"},{name:"end",type:"int"},{name:"length",type:"int"},{name:"ref",type:"string"},{name:"alt",type:"string"},{name:"chunkIds",type:"auto"},{name:"hgvsType",type:"auto",mapping:"hgvs[0].type"},{name:"hgvsName",type:"auto",mapping:"hgvs[0].name"},{name:"geneName",type:"string"}],idProperty:"id"}),Ext.QuickTips.init(),Ext.state.Manager.setProvider(Ext.create("Ext.state.CookieProvider")),Ext.Ajax.useDefaultXhrHeader=!1,Ext.Ajax.cors=!0;var b=METADATA_HOST+"/"+VERSION+"/genes/"+a.gene+"/variants";console.log(b),a.gbStore=Ext.create("Ext.data.JsonStore",{model:this.geneTableID,data:[],groupField:"geneName"});var c=Ext.create("Ext.grid.feature.Grouping",{groupHeaderTpl:'{name} ({rows.length} Item{[values.rows.length > 1 ? "s" : ""]})'});a.gbGrid=Ext.create("Ext.grid.Panel",{store:a.gbStore,stateful:!0,collapsible:!0,multiSelect:!0,features:[c],columns:{items:[{text:"Chromosome",sortable:!0,dataIndex:"chr"},{text:"Start",sortable:!0,dataIndex:"start"},{text:"End",sortable:!0,dataIndex:"end"},{text:"Length",sortable:!0,dataIndex:"length"},{text:"ID",sortable:!1,dataIndex:"id"},{text:"Type",sortable:!0,dataIndex:"type"},{text:"REF/ALT",sortable:!0,dataIndex:"ref",xtype:"templatecolumn",tpl:"{ref}/{alt}"},{text:"HGVS Name",sortable:!0,dataIndex:"hgvsName"}],defaults:{flex:1,align:"center"}},height:350,autoWidth:!0,autoScroll:!1,title:"Gene Data",renderTo:this.geneTableID,viewConfig:{enableTextSelection:!0,forceFit:!0},deferredRender:!1});
var d=a._fetchData(b),e=a._groupData(d);return console.log(e),a.gbGrid.getStore().loadData(e.response.result),a.gbGrid},_fetchData:function(a){var b;return $.ajax({url:a,async:!1,dataType:"json",success:function(a){b=a},error:function(){b=""}}),b},_groupData:function(a){for(var b=a,c=0;c<b.response.result.length;c++)b.response.result[c].geneName=b.response.result[c].effects[0].geneName;return b}},VariantGenotypeWidget.prototype={draw:function(){this._createGenotypeGrid()},_createGenotypeGrid:function(){var a=this;jQuery("#"+a.render_id+" div").length&&jQuery("#"+a.render_id+" div").remove(),Ext.Loader.setConfig({enabled:!0}),Ext.Loader.setPath("Ext.ux","vendor/extJS/ux"),Ext.require(["Ext.data.*","Ext.grid.*","Ext.util.*","Ext.ux.data.PagingMemoryProxy","Ext.toolbar.Paging","Ext.ux.SlidingPager"]);var b=a._parseData();return b?(Ext.define(a.render_id,{extend:"Ext.data.Model",fields:b.fields}),a.vgStore=Ext.create("Ext.data.Store",{model:a.render_id,remoteSort:!0,pageSize:a.pageSize,proxy:{type:"pagingmemory",data:b.data,reader:{type:"array"}}}),a.vgGrid=Ext.create("Ext.grid.Panel",{header:!1,store:a.vgStore,stateful:!0,collapsible:!0,multiSelect:!0,columns:b.columns,height:350,autoWidth:!0,autoScroll:!1,title:a.title,renderTo:a.render_id,viewConfig:{enableTextSelection:!0,forceFit:!0},deferredRender:!1,bbar:Ext.create("Ext.PagingToolbar",{pageSize:10,store:a.vgStore,displayInfo:!0,plugins:Ext.create("Ext.ux.SlidingPager",{})})}),a.vgStore.load(),a.vgGrid):void 0},_parseData:function(){var a=this,b=[],c=[],d=a._fetchData(a.url),e=[];if(d.response.numResults){var f=d.response.result[0].files[0].samples;for(key in f){var g=new Array,e=new Array;g.push(key);for(k in f[key])e.push(k),g.push(f[key][k]);c.push(g)}var h=[],i=[];h.push("Samples");var i=[{text:"Samples",flex:1,sortable:!1,dataIndex:"Samples",align:"center"}];for(key in e)h.push(e[key]),i.push({text:e[key],flex:1,sortable:!1,dataIndex:e[key],align:"center"});return b.data=c,b.fields=h,b.columns=i,b}},_fetchData:function(a){var b;return $.ajax({url:a,async:!1,dataType:"json",success:function(a){b=a},error:function(){b=""}}),b}},angular.module("ebiVar.Services.Metadata",[]).service("ebiVarMetadataService",function(){this.fetchData=function(a){var b=a;return $.ajax({url:b,async:!1,dataType:"json",success:function(a){data=a},error:function(){data=""}}),data}});